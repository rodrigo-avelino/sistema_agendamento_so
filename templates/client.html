<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cliente - Agendamento (Simula√ß√£o SO)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --color-primary-dark: #1e3a8a;
            --color-success: #10b981;
            --color-warning: #facc15;
            --color-danger: #ef4444;
            --color-dark: #1f2937;
        }
        .slot-btn { width: 90px; margin: 4px; transition: all 0.2s; position: relative; border-radius: 8px; font-weight: 600; }
        .slot-livre { background-color: var(--color-success); color: white; border: none; }
        .slot-selecionado-mim { background-color: var(--color-primary-dark); color: white; border: 2px solid #fff; box-shadow: 0 0 12px rgba(30, 58, 138, 0.8); z-index: 10; transform: scale(1.05); }
        .slot-bloqueado-outros { background-color: var(--color-warning); color: var(--color-dark); cursor: not-allowed; opacity: 0.9; border: 2px dashed var(--color-dark); }
        .slot-ocupado-definitivo { background-color: var(--color-danger); color: white; cursor: pointer; opacity: 1; font-style: italic; }
        
        .console-log { background: var(--color-dark); color: #34d399; height: 250px; overflow-y: scroll; font-family: 'Consolas', monospace; font-size: 13px; padding: 15px; border-radius: 0 0 10px 10px; }
        
        /* Painel de Confirma√ß√£o Expandido */
        #confirm-panel { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; padding: 20px 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); display: none; z-index: 1000; border: 1px solid #ddd; text-align: center; min-width: 350px; }
        
        .text-primary, .btn-primary { color: var(--color-primary-dark) !important; }
        .bg-primary, .btn-primary { background-color: var(--color-primary-dark) !important; border-color: var(--color-primary-dark) !important; color: white !important; }
        .navbar-dark { background-color: var(--color-dark) !important; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <span class="navbar-brand mb-0 h1"><i class="bi bi-calendar-check-fill me-2"></i>Sistema de Agendamento (Simula√ß√£o SO)</span>
            <a href="/admin" class="btn btn-sm btn-outline-light"><i class="bi bi-gear-fill me-1"></i> Painel Admin</a>
        </div>
    </nav>

    <div class="container mt-5">
        <div class="card shadow-sm border-0 mb-5">
            <div class="card-body py-4 d-flex align-items-center gap-4 bg-white rounded" style="border-radius: 12px;">
                <h4 class="mb-0" style="color: var(--color-primary-dark)"><i class="bi bi-calendar-date me-2"></i>Selecione a Data:</h4>
                <input type="date" id="data-selecionada" class="form-control form-control-lg w-auto fw-bold shadow-sm">
                <span class="badge bg-secondary fs-6 p-2" id="dia-semana-display">...</span>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-md-8">
                <div class="card shadow-lg" style="border-radius: 10px;">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>M√©dicos Dispon√≠veis</h5>
                        <span id="status-conn" class="badge bg-danger p-2"><i class="bi bi-wifi-off"></i> Conectando...</span>
                    </div>
                    <div class="card-body" id="medicos-container">
                        <div class="text-center p-5"><div class="spinner-border"></div><br>Carregando...</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-lg" style="border-radius: 10px;">
                    <div class="card-header bg-dark text-white"><h5 class="mb-0"><i class="bi bi-cpu-fill me-2"></i>Monitor de Eventos</h5></div>
                    <div class="card-body p-0"><div class="console-log" id="ws-log"></div></div>
                </div>
                <div class="mt-4 p-3 bg-white rounded-lg shadow-sm small" style="border-left: 5px solid var(--color-primary-dark);">
                    <h6 class="fw-bold mb-2">Legenda de Sincroniza√ß√£o:</h6>
                    <div class="d-flex flex-column gap-1">
                        <span><span class="badge" style="background-color: var(--color-success)">üü¢</span> Livre (Dispon√≠vel)</span>
                        <span><span class="badge" style="background-color: var(--color-primary-dark)">üîµ</span> Azul: Seu Lock Tempor√°rio</span>
                        <span><span class="badge" style="background-color: var(--color-warning); color: #000">üü°</span> Amarelo: Lock de Outro (Conflito)</span>
                        <span><span class="badge" style="background-color: var(--color-danger)">üî¥</span> Vermelho: Ocupado (Gravado em Disco)</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-panel">
        <h5><i class="bi bi-check-circle-fill text-success me-1"></i> Confirmar Agendamento</h5>
        <div class="alert alert-light border my-2 py-2" id="confirm-msg" style="font-size: 0.9rem;">...</div>
        
        <div class="mb-3 text-start">
            <label for="paciente-nome" class="form-label small fw-bold text-muted">Nome do Paciente:</label>
            <input type="text" class="form-control" id="paciente-nome" placeholder="Digite o nome do paciente " autocomplete="off">
        </div>

        <div class="d-flex gap-3 justify-content-center">
            <button class="btn btn-outline-secondary" onclick="cancelarSelecaoAtual()"><i class="bi bi-x-lg me-1"></i> Cancelar</button>
            <button class="btn btn-success" onclick="persistirAgendamento()"><i class="bi bi-save me-1"></i> Confirmar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const MEU_CLIENT_ID = "client_" + Math.floor(Math.random() * 10000);
        let socket = null;
        let meuLockAtual = null;
        let medicosCache = [];
        const DIAS_SEMANA_MAP = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];

        function log(msg) {
            const div = document.getElementById('ws-log');
            const time = new Date().toLocaleTimeString();
            div.innerHTML += `<div><span style="opacity:0.5">[${time}]</span> ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const hoje = new Date().toISOString().split('T')[0];
            const inputDate = document.getElementById('data-selecionada');
            inputDate.value = hoje;
            inputDate.min = hoje;
            atualizarLabelDia(hoje);
            inputDate.addEventListener('change', (e) => {
                atualizarLabelDia(e.target.value);
                limparSelecaoLocal();
                redesenharTodosMedicos();
                carregarAgendamentosOcupados();
            });
            init();
        });

        function atualizarLabelDia(dataStr) {
            const dataObj = new Date(dataStr + 'T00:00:00');
            const dia = DIAS_SEMANA_MAP[dataObj.getDay()];
            document.getElementById('dia-semana-display').innerText = `${dia}-feira`;
        }

        async function init() {
            conectarWS();
            await carregarMedicos();
            await carregarAgendamentosOcupados();
        }

        async function carregarMedicos() {
            try {
                const res = await fetch('/api/medicos');
                medicosCache = await res.json();
                redesenharTodosMedicos();
            } catch (e) { console.error(e); }
        }

        function redesenharTodosMedicos() {
            const container = document.getElementById('medicos-container');
            container.innerHTML = '';
            if (medicosCache.length === 0) {
                container.innerHTML = '<div class="alert alert-warning border-0">Nenhum m√©dico cadastrado.</div>';
                return;
            }
            medicosCache.forEach(m => renderizarMedico(m));
        }

        function renderizarMedico(medico) {
            const container = document.getElementById('medicos-container');
            const dataSelecionada = document.getElementById('data-selecionada').value;
            const dataObj = new Date(dataSelecionada + 'T00:00:00');
            const diaSemana = DIAS_SEMANA_MAP[dataObj.getDay()];

            const card = document.createElement('div');
            card.className = 'card mb-3 shadow-sm';
            card.id = `card-medico-${medico.id}`;

            let slotsHtml = '';
            const horasDoDia = medico.disponibilidade ? (medico.disponibilidade[diaSemana] || []) : [];

            if (horasDoDia.length === 0) {
                slotsHtml = `<div class="text-muted small p-3 bg-light rounded border"><i><i class="bi bi-info-circle me-1"></i> Sem atendimento nesta ${diaSemana}-feira.</i></div>`;
            } else {
                horasDoDia.forEach(hora => {
                    const recursoId = `${medico.id}|${dataSelecionada}T${hora}`;
                    slotsHtml += `<button id="btn-${recursoId}" class="btn slot-btn slot-livre" onclick="interagirSlot('${medico.id}', '${dataSelecionada}T${hora}', '${recursoId}')">${hora}</button>`;
                });
            }

            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <h5 class="card-title fw-bold" style="color: var(--color-primary-dark)"><i class="bi bi-person-circle me-2"></i>${medico.nome}</h5>
                        <span class="badge bg-info text-dark p-2">${medico.especialidade}</span>
                    </div>
                    <div class="mt-2 d-flex flex-wrap gap-1">${slotsHtml}</div>
                </div>`;
            container.append(card);
        }

        async function carregarAgendamentosOcupados() {
            try {
                const res = await fetch('/api/consultas');
                const consultas = await res.json();
                const dataAtual = document.getElementById('data-selecionada').value;
                document.querySelectorAll('.slot-ocupado-definitivo').forEach(b => b.className = 'btn slot-btn slot-livre');
                consultas.forEach(c => {
                    if (c.data_hora.startsWith(dataAtual)) {
                        const recursoId = `${c.medico_id}|${c.data_hora}`;
                        atualizarVisualSlot(recursoId, 'ocupado');
                    }
                });
            } catch(e) {}
        }

        function conectarWS() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/api/ws`);

            socket.onopen = () => {
                document.getElementById('status-conn').className = 'badge bg-success p-2';
                document.getElementById('status-conn').innerHTML = '<i class="bi bi-wifi"></i> Online';
                log("WS Conectado. ID: " + MEU_CLIENT_ID);
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                const dataAtual = document.getElementById('data-selecionada').value;

                switch(msg.tipo) {
                    case 'novo_medico':
                    case 'atualizacao_medico':
                    case 'recurso_removido':
                        carregarMedicos();
                        carregarAgendamentosOcupados();
                        log(`<span class="text-info">${msg.tipo.toUpperCase()}</span>: Sincronizando cat√°logo.`);
                        break;
                    case 'bloqueio_temporario':
                    case 'desbloqueio_temporario':
                    case 'novo_agendamento':
                    case 'agendamento_cancelado':
                        let dataEvento = "";
                        if (msg.recurso) dataEvento = msg.recurso.split('|')[1].split('T')[0];
                        else if (msg.dados) dataEvento = msg.dados.data_hora.split('T')[0];
                        else if (msg.data_hora) dataEvento = msg.data_hora.split('T')[0];

                        if (dataEvento === dataAtual) {
                            processarEventoVisual(msg);
                            log(`[${msg.tipo}] Recurso atualizado.`);
                        }
                        break;
                    case 'resposta_selecao':
                        if (msg.sucesso) {
                            meuLockAtual = {
                                recursoId: msg.recurso,
                                medico_id: msg.dados_originais.medico_id,
                                data_hora: msg.dados_originais.data_hora
                            };
                            atualizarVisualSlot(msg.recurso, 'meu_bloqueio');
                            
                            const medico = medicosCache.find(m => String(m.id) === String(msg.dados_originais.medico_id));
                            const nomeMedico = medico ? medico.nome : "M√©dico Desconhecido";
                            const hora = msg.dados_originais.data_hora.split('T')[1];
                            const data = msg.dados_originais.data_hora.split('T')[0];
                            
                            document.getElementById('confirm-msg').innerHTML = `
                                <strong>${nomeMedico}</strong><br>
                                Data: ${data} √†s ${hora}
                            `;
                            
                            mostrarPainelConfirmacao(true);
                            // Foca no input do nome assim que o modal abre
                            setTimeout(() => document.getElementById('paciente-nome').focus(), 100);
                            log('<span class="text-primary">LOCK OBTIDO</span>. Aguardando dados do paciente.');
                        } else {
                            alert("Conflito: Hor√°rio bloqueado por outro usu√°rio.");
                            log('<span class="text-warning">LOCK FALHOU</span>. Recurso ocupado.');
                        }
                        break;
                }
            };

            socket.onclose = () => {
                document.getElementById('status-conn').className = 'badge bg-danger p-2';
                document.getElementById('status-conn').innerHTML = 'Offline';
            };
        }

        function processarEventoVisual(msg) {
            if (msg.tipo === 'bloqueio_temporario') {
                if (msg.dono_id !== MEU_CLIENT_ID) atualizarVisualSlot(msg.recurso, 'bloqueado');
            } else if (msg.tipo === 'desbloqueio_temporario') {
                atualizarVisualSlot(msg.recurso, 'livre');
            } else if (msg.tipo === 'novo_agendamento') {
                const id = `${msg.dados.medico_id}|${msg.dados.data_hora}`;
                atualizarVisualSlot(id, 'ocupado');
                if (meuLockAtual && meuLockAtual.recursoId === id) limparSelecaoLocal();
            } else if (msg.tipo === 'agendamento_cancelado') {
                const id = `${msg.medico_id}|${msg.data_hora}`;
                atualizarVisualSlot(id, 'livre');
            }
        }

        function interagirSlot(medicoId, dataHora, recursoId) {
            const btn = document.getElementById(`btn-${recursoId}`);
            if (!btn) return;
            if (btn.classList.contains('slot-ocupado-definitivo')) {
                if(confirm("Hor√°rio ocupado. Simular cancelamento?")) desocuparHorario(medicoId, dataHora);
                return;
            }
            if (btn.classList.contains('slot-bloqueado-outros')) {
                alert("Hor√°rio em uso por outro usu√°rio.");
                return;
            }
            if (meuLockAtual && meuLockAtual.recursoId === recursoId) {
                cancelarSelecaoAtual();
                return;
            }
            if (meuLockAtual) {
                alert("Conclua a sele√ß√£o atual primeiro.");
                return;
            }
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ acao: 'selecionar', medico_id: String(medicoId), data_hora: dataHora, client_id: MEU_CLIENT_ID }));
            }
        }

        function cancelarSelecaoAtual() {
            if (!meuLockAtual) return;
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ acao: 'cancelar_selecao', medico_id: String(meuLockAtual.medico_id), data_hora: meuLockAtual.data_hora, client_id: MEU_CLIENT_ID }));
            }
            atualizarVisualSlot(meuLockAtual.recursoId, 'livre');
            limparSelecaoLocal();
            log('Sele√ß√£o cancelada.');
        }

        async function persistirAgendamento() {
            if (!meuLockAtual) return;
            
            // --- PEGAR NOME DO PACIENTE ---
            const inputNome = document.getElementById('paciente-nome');
            const nomePaciente = inputNome.value.trim();
            
            if (!nomePaciente) {
                alert("Por favor, digite o nome do paciente para confirmar.");
                inputNome.focus();
                return;
            }
            // ------------------------------

            try {
                const response = await fetch('/api/agendar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        paciente_nome: nomePaciente, // Envia o nome real
                        medico_id: parseInt(meuLockAtual.medico_id), 
                        data_hora: meuLockAtual.data_hora 
                    })
                });
                if (response.ok) {
                    log('<span class="text-success">GRAVA√á√ÉO OK</span>. Dados persistidos.');
                } else {
                    const err = await response.json();
                    alert("Erro: " + (err.detail || "Falha ao salvar"));
                }
            } catch (e) { log('Erro de conex√£o.'); } finally { limparSelecaoLocal(); }
        }

        async function desocuparHorario(medicoId, dataHora) {
            await fetch('/api/cancelar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ medico_id: parseInt(medicoId), data_hora: dataHora })
            });
        }

        function mostrarPainelConfirmacao(show) { 
            const panel = document.getElementById('confirm-panel');
            panel.style.display = show ? 'block' : 'none';
            if (!show) {
                // Limpa o input ao fechar
                document.getElementById('paciente-nome').value = '';
            }
        }
        function limparSelecaoLocal() { meuLockAtual = null; mostrarPainelConfirmacao(false); }
        function atualizarVisualSlot(recursoId, estado) {
            const btn = document.getElementById(`btn-${recursoId}`);
            if (!btn) return;
            btn.className = 'btn slot-btn';
            if (estado === 'livre') btn.classList.add('slot-livre');
            if (estado === 'meu_bloqueio') btn.classList.add('slot-selecionado-mim');
            if (estado === 'bloqueado') btn.classList.add('slot-bloqueado-outros');
            if (estado === 'ocupado') btn.classList.add('slot-ocupado-definitivo');
        }
    </script>
</body>
</html>