<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cliente - Agendamento (Simula√ß√£o)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .slot-btn { width: 80px; margin: 2px; transition: all 0.2s; position: relative; }
        /* Cores do Sem√°foro */
        .slot-livre { background-color: #28a745; color: white; }
        .slot-selecionado-mim { background-color: #0d6efd; color: white; border: 2px solid #000; box-shadow: 0 0 10px #0d6efd; z-index: 10; }
        .slot-bloqueado-outros { background-color: #ffc107; color: black; cursor: not-allowed; opacity: 0.7; }
        .slot-ocupado-definitivo { background-color: #dc3545; color: white; cursor: pointer; }
        
        .console-log { background: #000; color: #0f0; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px; padding: 10px; }
        
        /* Painel de Confirma√ß√£o */
        #confirm-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 15px; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none; z-index: 1000; border: 1px solid #ccc; text-align: center;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-4">
        
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card border-primary">
                    <div class="card-body py-3 d-flex align-items-center gap-3 bg-white rounded">
                        <h5 class="mb-0 text-primary">üìÖ Data da Consulta:</h5>
                        <input type="date" id="data-selecionada" class="form-control w-auto fw-bold shadow-sm">
                        <span class="badge bg-secondary fs-6" id="dia-semana-display">...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">M√©dicos Dispon√≠veis</h5>
                        <span id="status-conn" class="badge bg-danger">Conectando...</span>
                    </div>
                    <div class="card-body" id="medicos-container">
                        <div class="text-center p-5"><div class="spinner-border"></div><br>Carregando...</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">Monitor de Eventos (SO)</div>
                    <div class="card-body p-0">
                        <div class="console-log" id="ws-log"></div>
                    </div>
                </div>
                <div class="mt-3 p-3 bg-white rounded shadow-sm small">
                    <strong>Legenda de Estados:</strong><br>
                    üü¢ Livre (Dispon√≠vel)<br>
                    üîµ Azul (Seu Lock Tempor√°rio)<br>
                    üü° Amarelo (Lock de Outro Processo)<br>
                    üî¥ Vermelho (Persistido em Disco)
                </div>
            </div>
        </div>
    </div>

    <div id="confirm-panel">
        <h5>Confirmar Agendamento?</h5>
        <p class="small text-muted mb-2" id="confirm-msg">...</p>
        <div class="d-flex gap-2 justify-content-center">
            <button class="btn btn-secondary btn-sm" onclick="cancelarSelecaoAtual()">Cancelar</button>
            <button class="btn btn-success btn-sm" onclick="persistirAgendamento()">üíæ Confirmar (Gravar)</button>
        </div>
    </div>

    <script>
        const MEU_CLIENT_ID = "client_" + Math.floor(Math.random() * 10000);
        let socket = null;
        let meuLockAtual = null;
        let medicosCache = []; // Cache local para evitar requisi√ß√µes desnecess√°rias ao mudar data
        
        // Mapeamento do getDay() do JS (0=Domingo) para as chaves do JSON
        const DIAS_SEMANA_MAP = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sab'];

        function log(msg) {
            const div = document.getElementById('ws-log');
            const time = new Date().toLocaleTimeString();
            div.innerHTML += `<div><span style="opacity:0.5">[${time}]</span> ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Configura Data Inicial (Hoje)
            const hoje = new Date().toISOString().split('T')[0];
            const inputDate = document.getElementById('data-selecionada');
            inputDate.value = hoje;
            inputDate.min = hoje; 
            
            atualizarLabelDia(hoje);

            // Evento: Mudan√ßa de Data
            inputDate.addEventListener('change', (e) => {
                atualizarLabelDia(e.target.value);
                limparSelecaoLocal(); // N√£o pode manter lock de um dia vendo outro
                redesenharTodosMedicos(); // Filtra hor√°rios pelo novo dia da semana
                carregarAgendamentosOcupados(); // Busca ocupados da nova data
            });

            init();
        });

        function atualizarLabelDia(dataStr) {
            // Cria data ajustando fuso hor√°rio para garantir dia correto
            const dataObj = new Date(dataStr + 'T00:00:00');
            const dia = DIAS_SEMANA_MAP[dataObj.getDay()];
            document.getElementById('dia-semana-display').innerText = `${dia}-feira`;
        }

        async function init() {
            conectarWS();
            await carregarMedicos();
            await carregarAgendamentosOcupados();
        }

        // --- 1. RENDERIZA√á√ÉO ---
        async function carregarMedicos() {
            try {
                const res = await fetch('/api/medicos');
                medicosCache = await res.json();
                redesenharTodosMedicos();
            } catch (e) { console.error(e); }
        }

        function redesenharTodosMedicos() {
            const container = document.getElementById('medicos-container');
            container.innerHTML = '';
            
            if (medicosCache.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">Nenhum m√©dico cadastrado.</div>';
                return;
            }
            medicosCache.forEach(m => renderizarMedico(m));
        }

        function renderizarMedico(medico) {
            const container = document.getElementById('medicos-container');
            const dataSelecionada = document.getElementById('data-selecionada').value;
            
            // Descobre qual dia da semana √© a data selecionada
            const dataObj = new Date(dataSelecionada + 'T00:00:00');
            const diaSemana = DIAS_SEMANA_MAP[dataObj.getDay()];

            const card = document.createElement('div');
            card.className = 'card mb-3';
            card.id = `card-medico-${medico.id}`;

            // Filtra hor√°rios: Pega apenas a lista do dia da semana correspondente
            // Ex: se diaSemana √© 'Ter', pega medico.disponibilidade['Ter']
            let slotsHtml = '';
            const horasDoDia = medico.disponibilidade ? (medico.disponibilidade[diaSemana] || []) : [];

            if (horasDoDia.length === 0) {
                slotsHtml = `<div class="text-muted small p-2 bg-light rounded border">
                                <i>Sem atendimento nesta ${diaSemana}-feira.</i>
                             </div>`;
            } else {
                horasDoDia.forEach(hora => {
                    // ID √öNICO DO RECURSO: ID_MEDICO | DATA_COMPLETA | HORA
                    const recursoId = `${medico.id}|${dataSelecionada}T${hora}`;
                    
                    slotsHtml += `
                        <button id="btn-${recursoId}" 
                                class="btn slot-btn slot-livre" 
                                onclick="interagirSlot('${medico.id}', '${dataSelecionada}T${hora}', '${recursoId}')">
                            ${hora}
                        </button>`;
                });
            }

            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h5 class="card-title">${medico.nome}</h5>
                        <span class="badge bg-info text-dark">${medico.especialidade}</span>
                    </div>
                    <div class="mt-2 d-flex flex-wrap gap-1">${slotsHtml}</div>
                </div>
            `;
            container.append(card);
        }

        async function carregarAgendamentosOcupados() {
            try {
                const res = await fetch('/api/consultas');
                const consultas = await res.json();
                const dataAtual = document.getElementById('data-selecionada').value;

                // Limpa vermelhos antigos antes de aplicar novos
                document.querySelectorAll('.slot-ocupado-definitivo').forEach(b => b.className = 'btn slot-btn slot-livre');

                consultas.forEach(c => {
                    // Verifica se a consulta √© no dia que estou vendo
                    // Formato c.data_hora: "YYYY-MM-DDTHH:MM"
                    if (c.data_hora.startsWith(dataAtual)) {
                        const recursoId = `${c.medico_id}|${c.data_hora}`;
                        atualizarVisualSlot(recursoId, 'ocupado');
                    }
                });
            } catch(e) {}
        }

        // --- 2. WEBSOCKET ---
        function conectarWS() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            socket = new WebSocket(`${protocol}//${window.location.host}/api/ws`);

            socket.onopen = () => {
                document.getElementById('status-conn').className = 'badge bg-success';
                document.getElementById('status-conn').innerText = 'Online';
                log("WS Conectado.");
            };

            socket.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                const dataAtual = document.getElementById('data-selecionada').value;

                switch(msg.tipo) {
                    case 'novo_medico':
                        medicosCache.push(msg.dados);
                        redesenharTodosMedicos();
                        break;
                    
                    case 'atualizacao_medico':
                        const idx = medicosCache.findIndex(m => m.id === msg.dados.id);
                        if(idx !== -1) medicosCache[idx] = msg.dados;
                        redesenharTodosMedicos();
                        carregarAgendamentosOcupados(); // Re-aplica ocupados caso o bot√£o tenha sido recriado
                        break;
                    
                    case 'recurso_removido':
                        medicosCache = medicosCache.filter(m => String(m.id) !== String(msg.id));
                        redesenharTodosMedicos();
                        break;

                    // Eventos de Sem√°foro
                    case 'bloqueio_temporario':
                    case 'desbloqueio_temporario':
                    case 'novo_agendamento':
                    case 'agendamento_cancelado':
                        // Filtro: S√≥ processa visualmente se for na data que estou vendo
                        let dataEvento = "";
                        if (msg.recurso) dataEvento = msg.recurso.split('|')[1].split('T')[0];
                        else if (msg.dados) dataEvento = msg.dados.data_hora.split('T')[0];
                        else if (msg.data_hora) dataEvento = msg.data_hora.split('T')[0];

                        if (dataEvento === dataAtual) {
                            processarEventoVisual(msg);
                        }
                        break;

                    case 'resposta_selecao':
                        if (msg.sucesso) {
                            meuLockAtual = { 
                                recursoId: msg.recurso, 
                                medico_id: msg.dados_originais.medico_id, 
                                data_hora: msg.dados_originais.data_hora 
                            };
                            atualizarVisualSlot(msg.recurso, 'meu_bloqueio');
                            document.getElementById('confirm-msg').innerText = `Confirmar para ${msg.dados_originais.data_hora}?`;
                            mostrarPainelConfirmacao(true);
                        } else {
                            alert("Este hor√°rio acabou de ser bloqueado por outro usu√°rio.");
                        }
                        break;
                }
            };

            socket.onclose = () => {
                document.getElementById('status-conn').className = 'badge bg-danger';
                document.getElementById('status-conn').innerText = 'Offline';
            };
        }

        function processarEventoVisual(msg) {
            if (msg.tipo === 'bloqueio_temporario') {
                if (msg.dono_id !== MEU_CLIENT_ID) atualizarVisualSlot(msg.recurso, 'bloqueado');
            }
            else if (msg.tipo === 'desbloqueio_temporario') atualizarVisualSlot(msg.recurso, 'livre');
            else if (msg.tipo === 'novo_agendamento') {
                const id = `${msg.dados.medico_id}|${msg.dados.data_hora}`;
                atualizarVisualSlot(id, 'ocupado');
                if (meuLockAtual && meuLockAtual.recursoId === id) limparSelecaoLocal();
            }
            else if (msg.tipo === 'agendamento_cancelado') {
                const id = `${msg.medico_id}|${msg.data_hora}`;
                atualizarVisualSlot(id, 'livre');
            }
        }

        // --- 3. INTERA√á√ÉO ---
        function interagirSlot(medicoId, dataHora, recursoId) {
            const btn = document.getElementById(`btn-${recursoId}`);
            if (!btn) return;

            if (btn.classList.contains('slot-ocupado-definitivo')) {
                if (confirm("Hor√°rio ocupado. Liberar este hor√°rio?")) desocuparHorario(medicoId, dataHora);
                return;
            }
            if (btn.classList.contains('slot-bloqueado-outros')) {
                alert("Hor√°rio em uso por outro usu√°rio.");
                return;
            }
            if (meuLockAtual && meuLockAtual.recursoId === recursoId) {
                cancelarSelecaoAtual();
                return;
            }
            if (meuLockAtual) {
                alert("Voc√™ j√° tem uma sele√ß√£o pendente. Confirme ou cancele.");
                return;
            }
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    acao: 'selecionar',
                    medico_id: String(medicoId),
                    data_hora: dataHora
                }));
            }
        }

        function cancelarSelecaoAtual() {
            if (!meuLockAtual) return;
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    acao: 'cancelar_selecao',
                    medico_id: String(meuLockAtual.medico_id),
                    data_hora: meuLockAtual.data_hora
                }));
            }
            atualizarVisualSlot(meuLockAtual.recursoId, 'livre');
            limparSelecaoLocal();
        }

        async function persistirAgendamento() {
            if (!meuLockAtual) return;
            try {
                const response = await fetch('/api/agendar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paciente_nome: "Cliente Teste",
                        medico_id: parseInt(meuLockAtual.medico_id),
                        data_hora: meuLockAtual.data_hora
                    })
                });
                if (!response.ok) {
                    const err = await response.json();
                    alert("Erro: " + (err.detail || "Falha ao salvar"));
                }
            } catch (e) { alert("Erro de conex√£o."); }
        }

        async function desocuparHorario(medicoId, dataHora) {
            await fetch('/api/cancelar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ medico_id: parseInt(medicoId), data_hora: dataHora })
            });
        }

        // UI Helpers
        function mostrarPainelConfirmacao(show) { document.getElementById('confirm-panel').style.display = show ? 'block' : 'none'; }
        function limparSelecaoLocal() { meuLockAtual = null; mostrarPainelConfirmacao(false); }
        function atualizarVisualSlot(recursoId, estado) {
            const btn = document.getElementById(`btn-${recursoId}`);
            if (!btn) return; // Bot√£o pode n√£o existir se data mudou
            
            btn.className = 'btn slot-btn'; 
            if (estado === 'livre') btn.classList.add('slot-livre');
            if (estado === 'meu_bloqueio') btn.classList.add('slot-selecionado-mim');
            if (estado === 'bloqueado') btn.classList.add('slot-bloqueado-outros');
            if (estado === 'ocupado') btn.classList.add('slot-ocupado-definitivo');
        }
    </script>
</body>
</html>